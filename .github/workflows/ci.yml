name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  quality:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: "file:./prisma/dev.db"
      DIRECT_URL: "file:./prisma/dev.db"
      NEXTAUTH_URL: "http://localhost:3000"
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'ci-secret-min-32-chars-long-for-test' }}
      INTERNAL_CRON_SECRET: ${{ secrets.INTERNAL_CRON_SECRET || 'ci-internal-cron-secret-16chars' }}

      # Stripe (mogÄ… byÄ‡ puste w CI jeÅ›li nie sÄ… walidowane jako required)
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      STRIPE_PRICE_ID_PRO: ${{ secrets.STRIPE_PRICE_ID_PRO }}
      STRIPE_PRODUCT_ID_PRO: ${{ secrets.STRIPE_PRODUCT_ID_PRO }}
      APP_URL: ${{ secrets.APP_URL }}

      # ðŸ”¥ FIX: dÅ‚ugi dummy fallback, Å¼eby walidacja przeszÅ‚a
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-ci-1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_1234567890' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npm run db:generate

      - name: Run CI gates (lint, typecheck, build)
        run: npm run ci
      
